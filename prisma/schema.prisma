generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  new_design
  awaiting_materials
  in_production
  quality_check
  ready_for_pickup
  picked_up
  completed
  cancelled
}

enum IntakeChannel {
  walk_in
  appointment
  web_lead
}

enum PaymentStatus {
  paid
  refunded
  voided
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  role         String   // "admin" | "staff"
  passwordHash String
  createdAt    DateTime @default(now())

  orders       Order[]
  activity     ActivityLog[] @relation("ActorActivity")
}

model Customer {
  id               String   @id @default(uuid())
  firstName        String
  lastName         String
  phone            String   @unique
  email            String?
  addressLine1     String?
  addressLine2     String?
  city             String?
  state            String?
  zip              String?
  preferredContact String   @default("email") // "email" | "call"
  marketingOptIn   Boolean  @default(false)
  marketingOptInAt DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  orders           Order[]
}

model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])

  status          OrderStatus   @default(new_design)
  intakeChannel   IntakeChannel @default(walk_in)
  dueDate         DateTime?
  itemType        String
  itemDescription String?
  width           Decimal?
  height          Decimal?
  units           String        @default("in") // "in" | "cm"
  notesInternal   String?
  notesCustomer   String?

  subtotalAmount  Int
  taxAmount       Int
  totalAmount     Int
  currency        String        @default("USD")
  paidInFull      Boolean       @default(true)

  createdByUserId String
  createdBy       User          @relation(fields: [createdByUserId], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  specs           OrderSpecs?
  photos          OrderPhoto[]
  payments        Payment[]
  activity        ActivityLog[] @relation("OrderActivity")
}

model OrderSpecs {
  id            String   @id @default(uuid())
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  frameCode     String?
  frameVendor   String?
  mat1Code      String?
  mat2Code      String?
  glassType     String?
  mountType     String?
  backingType   String?
  spacers       Boolean  @default(false)
  specialtyType String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model OrderPhoto {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  url       String
  caption   String?
  createdAt DateTime @default(now())
}

model Payment {
  id              String        @id @default(uuid())
  orderId          String
  order            Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  processor        String        @default("square")
  squarePaymentId  String        @unique
  squareReceiptUrl String?
  amount           Int
  status           PaymentStatus @default(paid)
  paidAt           DateTime
  rawMetadata      Json          @default("{}")
  createdAt        DateTime      @default(now())
}

model Appointment {
  id              String   @id @default(uuid())
  provider        String   @default("calcom")
  externalEventId String   @unique

  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])

  name            String
  email           String
  phone           String?
  startTime       DateTime
  endTime         DateTime
  notes           String?
  createdAt       DateTime @default(now())
}

model ActivityLog {
  id          String   @id @default(uuid())
  entityType  String
  entityId    String
  action      String

  actorUserId String?
  actor       User?    @relation("ActorActivity", fields: [actorUserId], references: [id])

  orderId     String?
  order       Order?   @relation("OrderActivity", fields: [orderId], references: [id])

  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
}
